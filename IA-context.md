# ðŸ§  IA Context: ASCII Architect Project

> **System Note for Future AI Agents:**  
> This document outlines the technical constraints, terminology, and architecture of the "ASCII Architect" project. Use this as your primary source of truth to avoid hallucinations about the codebase structure or capability.

---

## 1. Project Identity

**Name:** ASCII Architect (Project Terminal-God)  
**Goal:** Create an engineering-grade ASCII diagram generation tool that runs in the terminal (`cli`), powered by specialized small-language models (SLMs) based on GPT-2.  
**Philosophy:** "Engineering over Art". Precision (straight lines, exact dimensions) is prioritized over artistic style.  
**Current Version:** V18 (Hybrid Engine with Procedural Diamonds)  
**Repository:** [Coxibius/ASCII-Architect](https://github.com/Coxibius/ASCII-Architect)

---

## 2. Technical Architecture

### Core Engine (`src/engine.py`)
- **Model:** Fine-tuned GPT-2 (`GPT2LMHeadModel`) - 124M parameters.
- **Location:** `models/ASCII_Architect_V1_Models/` and `models/ASCII_Architect_V2_Expansion/`
- **Logic:** Calls specialized "Expert" models based on `expert_type`.
    - **V1 Models:**
        - `expert_box`: Generates boxes/containers (rectangular shapes).
        - `expert_arrow`: Generates connection lines (horizontal/vertical).
    - **V2 Models (Expansion):**
        - `expert_diamond`: Generates small diamonds (â‰¤10 chars).
        - `expert_cylinder`: Generates database/storage shapes.
        - `expert_soft_box`: Generates soft boxes (rounded corners for START/END/USER nodes).
    - *Note:* `expert_diamond` exists but is NOT used for long text (see Procedural Diamonds below).

### The Router (`src/router.py`) â­ **ORCHESTRATOR PRINCIPAL**
- **Purpose:** The brain of the layout system. Orchestrates the placement of shapes generated by the Engine AND procedural shapes.
- **Current Logic:** 2D Grid Layout (`A -> B ; C -> D`) with Manhattan Routing (elbows).
- **Mechanism:**
    1.  **Parsing:** Splits flow string into a grid (rows separated by `;`, columns by `->`).
    2.  **Type Detection:** Auto-detects shape types based on keywords (BOX, DIAMOND, CYLINDER, SOFTBOX).
    3.  **HYBRID GENERATION:**
        - **BOX/CYLINDER/SOFTBOX**: Uses AI models via `engine.generate()`.
        - **DIAMOND (long text)**: Uses **Procedural Generation** (Saturn Effect).
    4.  **Grid Calculation:** Calculates absolute (x, y) coordinates for each node based on column widths and row heights.
    5.  **Stamping:** Stamps shapes onto `Canvas` at calculated positions.
    6.  **Arrow Routing:** Draws horizontal arrows (`->`), vertical arrows (`|`, `v`), and elbow connections (`+`).
    7.  **Smart Anchors:** Uses precise N/S/E/W connection points for each shape type.

### Canvas System (`src/ascii_architect/canvas.py`)
- **Purpose:** 2D grid rendering system.
- **Functionality:**
    - Maintains a character matrix (width Ã— height).
    - `stamp(x, y, ascii_art)`: Places multi-line ASCII art at absolute coordinates.
    - `put_char(x, y, char)`: Places a single character.
    - `render()`: Converts the matrix to a string for display.
- **Coordinates:** Origin (0,0) is **top-left**. X increases **right**, Y increases **down**.

### Procedural Diamonds: "The Saturn Effect" â­ **V18 INNOVATION**

**Problem Solved:** AI models struggle with large diamonds (>10 chars). Dynamic height scaling created tall "obelisk" shapes that looked unnatural.

**Solution:** Fixed-height procedural generation for long text using mini-cones.

**Trigger Logic:**
```python
if shape_type == "DIAMOND" and (len(node_text) > 10 or '\n' in node_text):
    # Use procedural Saturn Effect
```

**Visual Design ("Saturn Effect"):**
```
      /\
     /  \      <- Fixed 3-line top cap
    /    \
   WIDE_TEXT_CAN_BE
   LONGER_THAN_CONE  <- Text "floats" (Ghost Body)
    \    /     <- Fixed 3-line bottom cap
     \  /
      \/
```

**Key Features:**
- **Fixed Heights:** Top cone = 3 lines, Bottom cone = 3 lines (NO dynamic scaling).
- **Ghost Body:** NO vertical walls (`|`) or horizontal dividers (`+`). Text floats with space padding only.
- **Mini-Cones:** Centered horizontally relative to widest text line.
- **Text Overflow:** Text can be wider than cone base (the "Saturn rings" effect).
- **Smart Anchors:** East/West anchors centered on **text block** (y + 3 + text_height/2), not total height.

**Implementation (in `src/router.py`):**
- `_wrap_text()`: Wraps long text into max 10-char lines.
- `_generate_cone_diamond()`: Procedurally generates the Saturn Effect shape.
- `_get_node_shape()`: Dispatcher that chooses AI vs. procedural generation.
- `_get_anchors()`: Updated to center E/W on text block for diamonds.

### The CLI Interface (`src/cli.py`)
- **Library:** `Typer` (modern Python CLI framework).
- **Commands:**
    - `python src/cli.py box --text "Database" --size 14x5`
    - `python src/cli.py arrow --dir right --len 5`
    - `python src/cli.py flow "A -> B -> C"`
    - `python src/cli.py flow "USER -> LOGIN_API -> AUTH_SERVICE ; IS_LOGGED? -> USER_DB ; ERROR_PAGE"`

### Utilities (`src/utils.py`)
- **Text Injection:** `inject_text(ascii_art, text)` - Replaces `â–‘` characters with actual text content.
- **Cleaning:** Regex-based cleanup of AI-generated output.

---

## 3. Syntax & Tokens (The "Language")

The AI models are trained on a strict syntax. **Do not hallucinate new tokens.**

### A. Structural Tokens (The Skeleton)
| Token | Meaning | Usage |
| :--- | :--- | :--- |
| `<Lxx>` | **Line Index** | Ensures vertical alignment (e.g., `<L01>`, `<L02>`). Critical for multi-line shapes. |
| `[S:xx]` | **Space Math** | Horizontal offset/padding (e.g., `[S:05]` adds 5 spaces). Used for positioning. |
| `[STOP]` | **End of Generation** | Hard stop token. Signals the model to stop generating. |

### B. Visual Tokens (The Ink)
| Token | Meaning | Context |
| :--- | :--- | :--- |
| `â–‘` | **Alpha/Transparent** | Filled inside boxes to allow Python to inject text later. |
| `+ - |` | **Borders** | Standard box edges (corners, horizontal, vertical). |
| `/ \` | **Diagonals** | Used in diamond shapes and soft boxes. |
| `N S E W` | **Anchors** | Connection points (North, South, East, West) for the Router. |
| `> < ^ v` | **Arrowheads** | Directional indicators for connections. |

### C. Prompt Tags (The Instructions)
- **Type:** `[TYPE:BOX]`, `[TYPE:ARROW]`, `[TYPE:DIAMOND]`, `[TYPE:CYLINDER]`, `[TYPE:SOFTBOX]`
- **Style:** `[STYLE:SOLID]`, `[STYLE:ROUND]`, `[STYLE:DOTTED]`
- **Dimensions:** `[DIM:WxH]` (e.g., `[DIM:12x5]` - Crucial for V18).
- **Direction:** `[DIR:RIGHT]`, `[DIR:DOWN]` (For arrows).
- **Length:** `[LEN:xx]` (For arrows, e.g., `[LEN:10]`).

---

## 4. Dataset Generation System

### Factory Scripts (`datasets/`)
Procedural Python scripts that generate synthetic training data in JSONL format.

| Script | Purpose | Output | Size |
| :--- | :--- | :--- | :--- |
| `factory_boxes.py` | Generates variable-size boxes (5-20w Ã— 3-10h) | `dataset_boxes.jsonl` | ~1.7 MB |
| `factory_arrows.py` | Generates horizontal/vertical arrows | `dataset_arrows.jsonl` | ~660 KB |
| `factory_diamonds.py` | Generates diamond shapes (small) | `dataset_diamonds.jsonl` | ~4.4 MB |
| `factory_cylinders.py` | Generates database cylinder shapes | `dataset_cylinders.jsonl` | ~2.0 MB |
| `factory_soft_boxes.py` | Generates rounded corner boxes | `dataset_soft_boxes.jsonl` | ~1.7 MB |

**Format:** Each JSONL line contains:
```json
{"prompt": "[TYPE:BOX] [STYLE:SOLID] [DIM:12x5]", "completion": "<L01> [S:00] +----N----+\n<L02> [S:00] Wâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘E\n... [STOP]"}
```

### Training Notebooks (`notebooks/`)
Jupyter notebooks for model training and experimentation:
- `ascii-architect-00.ipynb`: Initial experiments.
- `v1-cuadrados-y-flechas.ipynb`: V1 training (boxes + arrows).
- `v1-rombos-y-cilindros.ipynb`: V2 training (diamonds + cylinders).
- `factory_cylinders-diamods-softboxes.ipynb`: V2 expansion dataset generation.

---

## 5. Current Status (Roadmap Snapshot)

### âœ… Completed (V18)
- **Hybrid Engine:** AI models + procedural generation working in harmony.
- **Canvas System:** Robust 2D grid stamping with absolute coordinates.
- **CLI Interface:** Typer-based commands for box, arrow, and flow generation.
- **Text Injection:** Python replaces `â–‘` with actual text content.
- **2D Grid Layout:** Supports rows (`;`) and columns (`->`).
- **Manhattan Routing:** Elbow connections with `+` corners for non-aligned nodes.
- **Smart Anchors:** Precise N/S/E/W connection points per shape type.
- **Procedural Diamonds (Saturn Effect):** Fixed-height cones for long text, prevents obelisk shapes.
- **5 Expert Models:** box, arrow, diamond, cylinder, soft_box.
- **Semantic Auto-Detection:** Automatically selects shape type based on keywords.

### ðŸš§ Next Steps (Future Work)
- **PyPI Packaging:** Create `pyproject.toml` for `pip install ascii-architect`.
- **Model Downloader:** Auto-download models from GitHub Releases on first run.
- **UML Enhancements:** Class diagrams, sequence diagrams, state machines.
- **ER Diagram Features:** Cardinality notation (Crow's Foot symbols: `|<`, `||`, `0<`).
- **Advanced Routing:** Obstacle avoidance, multi-segment paths.
- **Export Formats:** SVG, PNG export options.

---

## 6. Critical Implementation Notes for AI Agents

### Diamond Shape Logic (VERY IMPORTANT!)
**DO NOT** try to improve the AI diamond model for long text. The procedural Saturn Effect is THE solution.

**Decision Flow:**
1. Text â‰¤ 10 chars AND no newlines â†’ Use `expert_diamond` AI model.
2. Text > 10 chars OR contains `\n` â†’ Use `_generate_cone_diamond()` procedural generation.

**Never suggest:** "Let's train a better diamond model" or "Increase AI model context." The decision is **architectural**, not a training issue.

### Anchors for Diamonds (CRITICAL!)
**East/West anchors** for procedural diamonds are centered on the **TEXT BLOCK** (y + 3 + text_height/2), NOT the total shape height. This ensures arrows connect to content, not empty cone space.

**Formula:**
```python
TOP_CONE_HEIGHT = 3
BOTTOM_CONE_HEIGHT = 3
text_block_height = h - TOP_CONE_HEIGHT - BOTTOM_CONE_HEIGHT
text_block_center_y = y + TOP_CONE_HEIGHT + (text_block_height // 2)
anchors['e'] = (x + w - 1, text_block_center_y)
anchors['w'] = (x, text_block_center_y)
```

### Canvas Coordinates
- Origin (0,0) is **top-left**.
- X increases **right**, Y increases **down**.
- All coordinates are **absolute** (not relative).
- Stamping is done at absolute (x, y) positions.

### Shape Type Detection (Auto-Detection)
The router automatically detects shape types from text keywords:
- `"DB"`, `"DATA"`, `"SQL"` â†’ `CYLINDER`
- `"?"`, `"IF"`, `"DECISION"` â†’ `DIAMOND`
- `"START"`, `"END"`, `"USER"` â†’ `SOFTBOX`
- Default â†’ `BOX`

### Grid Layout Spacing
- **Horizontal Gap (GAP_X):** 6 characters (space for arrows between columns).
- **Vertical Gap (GAP_Y):** 4 lines (space for vertical arrows between rows).
- **Margins:** 2 characters/lines on all sides.

---

## 7. File Structure (Complete)

```text
C:\ASCII-Architect\
â”‚
â”œâ”€â”€ .github\                          # CI/CD workflows
â”œâ”€â”€ .venv\                            # Python virtual environment
â”‚
â”œâ”€â”€ models\                           # AI Model Weights (GPT-2)
â”‚   â”œâ”€â”€ ASCII_Architect_V1_Models\   # V1: expert_box, expert_arrow
â”‚   â”‚   â”œâ”€â”€ expert_box\
â”‚   â”‚   â””â”€â”€ expert_arrow\
â”‚   â””â”€â”€ ASCII_Architect_V2_Expansion\ # V2: expert_diamond, expert_cylinder, expert_soft_box
â”‚       â”œâ”€â”€ expert_diamond\
â”‚       â”œâ”€â”€ expert_cylinder\
â”‚       â””â”€â”€ expert_soft_box\
â”‚
â”œâ”€â”€ src\                              # ðŸ”¥ SOURCE CODE
â”‚   â”œâ”€â”€ router.py                     # â­ MAIN ORCHESTRATOR (2D Grid + Manhattan Routing)
â”‚   â”œâ”€â”€ engine.py                     # GPT-2 Wrapper (AI Model Interface)
â”‚   â”œâ”€â”€ cli.py                        # Typer CLI Interface
â”‚   â”œâ”€â”€ main.py                       # Alternative entry point
â”‚   â”œâ”€â”€ utils.py                      # Text injection, helpers
â”‚   â”œâ”€â”€ verify_diamond_custom.py      # Diamond validation script
â”‚   â”‚
â”‚   â””â”€â”€ ascii_architect\              # Python package (for PyPI)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ canvas.py                 # 2D Grid System (stamping)
â”‚       â”œâ”€â”€ cli.py                    # (Package CLI)
â”‚       â””â”€â”€ utils\
â”‚           â”œâ”€â”€ cleaning.py           # Regex cleanup (V17/V18)
â”‚           â””â”€â”€ downloader.py         # Auto-download models
â”‚
â”œâ”€â”€ datasets\                         # ðŸ“Š SYNTHETIC DATA GENERATION
â”‚   â”œâ”€â”€ factory_boxes.py              # Box dataset generator
â”‚   â”œâ”€â”€ factory_arrows.py             # Arrow dataset generator
â”‚   â”œâ”€â”€ factory_diamonds.py           # Diamond dataset generator
â”‚   â”œâ”€â”€ factory_cylinders.py          # Cylinder dataset generator
â”‚   â”œâ”€â”€ factory_soft_boxes.py         # Soft box dataset generator
â”‚   â”‚
â”‚   â”œâ”€â”€ dataset_boxes.jsonl           # ~1.7 MB
â”‚   â”œâ”€â”€ dataset_arrows.jsonl          # ~660 KB
â”‚   â”œâ”€â”€ dataset_diamonds.jsonl        # ~4.4 MB
â”‚   â”œâ”€â”€ dataset_cylinders.jsonl       # ~2.0 MB
â”‚   â””â”€â”€ dataset_soft_boxes.jsonl      # ~1.7 MB
â”‚
â”œâ”€â”€ notebooks\                        # ðŸ““ JUPYTER NOTEBOOKS
â”‚   â”œâ”€â”€ ascii-architect-00.ipynb
â”‚   â”œâ”€â”€ v1-cuadrados-y-flechas.ipynb
â”‚   â”œâ”€â”€ v1-rombos-y-cilindros.ipynb
â”‚   â””â”€â”€ factory_cylinders-diamods-softboxes.ipynb
â”‚
â”œâ”€â”€ docs\                             # ðŸ“š DOCUMENTATION
â”‚   â”œâ”€â”€ research_log_00.txt
â”‚   â”œâ”€â”€ research_log_01.txt
â”‚   â””â”€â”€ research_log_02.txt
â”‚
â”œâ”€â”€ scripts\                          # Auxiliary scripts
â”‚   â””â”€â”€ engine.py
â”‚
â”œâ”€â”€ tests\                            # ðŸ§ª UNIT TESTS
â”‚   â”œâ”€â”€ test_engine.py
â”‚   â””â”€â”€ test_canvas.py
â”‚
â”œâ”€â”€ assets\                           # Screenshots, visual resources
â”‚
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md                         # Main project documentation
â”œâ”€â”€ requirements.txt                  # Python dependencies
â”‚
â”œâ”€â”€ IA-context.md                     # ðŸ§  [THIS FILE] - AI Agent Context
â”œâ”€â”€ ROADMAP.txt                       # Development roadmap
â”œâ”€â”€ logica_del_motor.txt              # Engine logic documentation (V18 spec)
â”œâ”€â”€ estructura-de-carpetas.txt        # Project structure documentation
â”‚
â””â”€â”€ output.txt                        # Test/demo output
```

---

## 8. Common Pitfalls for AI Agents

### âŒ DO NOT:
1. **Suggest "training a better diamond model"** for long text â†’ Use procedural Saturn Effect.
2. **Modify anchor logic** without understanding Saturn Effect requirements.
3. **Try to make cones dynamically scale** with text width â†’ Keep fixed 3-line caps.
4. **Add borders to procedural diamonds** â†’ Maintain "ghost body" design (space padding only).
5. **Assume `src/engine.py` is the orchestrator** â†’ `src/router.py` is the main orchestrator.
6. **Hallucinate new tokens** â†’ Stick to documented syntax.
7. **Ignore the hybrid architecture** â†’ Some shapes use AI, some use procedural generation.

### âœ… DO:
1. **Use procedural Saturn Effect** for diamonds with text > 10 chars or containing `\n`.
2. **Keep E/W anchors centered on text block** for diamonds.
3. **Maintain fixed 3-line caps** for procedural diamonds (it's a feature, not a bug).
4. **Preserve the "ghost body" design** (space padding only, no borders).
5. **Understand the router is the brain** â†’ `src/router.py` orchestrates everything.
6. **Follow the documented token syntax** strictly.
7. **Respect the hybrid architecture** â†’ AI for some shapes, procedural for others.

---

## 9. Key Dependencies

```text
transformers>=4.30.0    # Hugging Face (GPT-2)
torch>=2.0.0            # PyTorch (model inference)
typer[all]              # CLI framework
```

---

## 10. Testing & Validation

### Manual Testing
```bash
# Test basic box
python src/cli.py box --text "Test" --size 12x5

# Test flow (horizontal)
python src/cli.py flow "A -> B -> C"

# Test grid (2D layout)
python src/cli.py flow "Start -> Process ; Decision? -> End"

# Test Saturn Effect (long diamond)
python src/cli.py flow "Very_Long_Decision_Text?"
```

### Validation Scripts
- `src/verify_diamond_custom.py`: Validates procedural diamond generation.

---

**Last Updated:** 2025-12-20  
**Major Changes:** Complete restructure with accurate file paths, all V1/V2 models documented, dataset information added, comprehensive technical context for AI agents, and clarified router.py as the main orchestrator.
